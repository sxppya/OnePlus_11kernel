name: Build 11
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: 'Do you want to create a release?'
        required: true
        type: boolean
        default: false
      device_codename:
        description: 'è¾“å…¥è®¾å¤‡ä»£å· (ä¾‹å¦‚ OP11)ï¼Œç”¨äºæ—¥å¿—å’Œé€šçŸ¥'
        required: true
        type: string
        default: 'OP11'
      ksun_branch:
        description: "Choose KernelSU Next Branch"
        required: true
        type: choice
        options:
          - stable
          - next
        default: next
      android13_5_15_susfs_branch:
        description: "Choose SusFS Branch for android13-5.15"
        type: string
        default: "gki-android13-5.15"

jobs:
  build-oneplus-11:
    name: build-oneplus-11 (${{ inputs.device_codename }}, ${{ inputs.ksun_branch }})
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Build Kernel
        # æ­¤æ­¥éª¤ä¼šè°ƒç”¨ .github/actions/action.yml
        # å®ƒä¼šæ„å»ºå†…æ ¸å¹¶ä¸Šä¼ ä¸€ä¸ªåä¸º "OP11_android13-5.15_Next_xxxxx_SUSFS_xxxxx" çš„äº§ç‰©
        uses: ./.github/actions/
        with:
          model: OP11
          soc: kalama
          branch: oneplus/sm8550
          manifest: oneplus_11_v.xml
          android_version: android13
          kernel_version: "5.15"
          ksun_branch: ${{ inputs.ksun_branch }}
          susfs_branch: ${{ inputs.android13_5_15_susfs_branch }}

  trigger-release:
    # ä¾èµ– build-oneplus-11 ä»»åŠ¡æˆåŠŸå®Œæˆ
    needs:
      - build-oneplus-11
    # åªæœ‰å½“ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹© make_release: true æ—¶æ‰è¿è¡Œ
    if: ${{ inputs.make_release }}
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: ğŸ“ Parse Artifact Info
        id: parser
        run: |
          # downloaded-artifacts ç›®å½•ä¸‹åº”è¯¥åªæœ‰ä¸€ä¸ªå­ç›®å½•ï¼Œå³ä¸Šä¸€æ­¥ä¸Šä¼ çš„äº§ç‰©
          ARTIFACT_DIR=$(ls -d downloaded-artifacts/*/)
          ARTIFACT_NAME=$(basename "$ARTIFACT_DIR")
          
          # æ‰¾åˆ°ç›®å½•ä¸‹çš„ zip æ–‡ä»¶
          ZIP_FILE_PATH=$(find "$ARTIFACT_DIR" -name "*.zip")
          ZIP_FILE_NAME=$(basename "$ZIP_FILE_PATH")

          # å°†è§£æå‡ºçš„ä¿¡æ¯è®¾ç½®ä¸ºè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "release_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "release_tag=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "zip_path=$ZIP_FILE_PATH" >> $GITHUB_OUTPUT
          echo "zip_name=$ZIP_FILE_NAME" >> $GITHUB_OUTPUT

      - name: ğŸš€ Upload to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.parser.outputs.release_name }}
          tag_name: ${{ steps.parser.outputs.release_tag }}
          # Prerelease è®¾ä¸º trueï¼Œè¡¨ç¤ºæ˜¯é¢„å‘å¸ƒç‰ˆ
          prerelease: true
          # åœ¨ Release Note ä¸­æ·»åŠ ä¸€äº›åŸºæœ¬ä¿¡æ¯
          body: |
            Release for ${{ inputs.device_codename }}
            KernelSU Branch: `${{ inputs.ksun_branch }}`
          # ä¸Šä¼  zip æ–‡ä»¶å’Œ Image æ–‡ä»¶
          files: |
            ${{ steps.parser.outputs.zip_path }}
            ${{ steps.parser.outputs.zip_path }}/Image

      - name: â¬†ï¸ Upload zip to Telegram
        if: success() && env.TG_BOT_TOKEN != '' && env.TG_CHAT_ID != ''
        run: |
          if [[ "${{ github.repository_owner }}" == "sxppya" ]]; then
            curl -F document=@"${{ steps.parser.outputs.zip_path }}" \
              -F chat_id=${TG_CHAT_ID} \
              -F caption="ğŸ“¦ å†…æ ¸æ„å»ºå®Œæˆï¼ è®¾å¤‡ï¼š${{ inputs.device_codename }}ï¼Œç‰ˆæœ¬ï¼š${{ steps.parser.outputs.release_tag }}" \
              https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument
          else
            echo "â›” éä¸»ä»“åº“ï¼Œè·³è¿‡ Telegram æ¨é€"
          fi

      - name: ğŸ“¦ Collect logs if release fails
        if: failure()
        run: |
          mkdir -p logs
          echo "ğŸ“… å‘å¸ƒæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')" > logs/BUILD_INFO.txt
          echo "ğŸ“± æ„å»ºè®¾å¤‡ï¼š${{ inputs.device_codename }}" >> logs/BUILD_INFO.txt
          echo "ğŸ”¢ æ„å»ºç‰ˆæœ¬ï¼šbuild-${{ github.run_number }}" >> logs/BUILD_INFO.txt
          echo "ğŸ“¦ ä»“åº“æ¥æºï¼š${{ github.repository }}" >> logs/BUILD_INFO.txt
          # æ³¨æ„ï¼šè¿™é‡Œåªèƒ½è®°å½• release ä»»åŠ¡çš„ä¿¡æ¯ï¼Œæ— æ³•è·å–ä¸Šä¸€ä¸ª build ä»»åŠ¡çš„è¯¦ç»†æ—¥å¿—æ–‡ä»¶
          zip -r logs.zip logs

      - name: ğŸ—‚ï¸ Upload release logs to GitHub
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_Release_Logs_${{ github.run_number }}
          path: logs.zip

      - name: ğŸš¨ Upload logs to Telegram (on failure)
        if: failure() && env.TG_BOT_TOKEN != '' && env.TG_CHAT_ID != ''
        run: |
          # æ­¤å‡½æ•°ç”¨äºè½¬ä¹‰ Telegram MarkdownV2 çš„ç‰¹æ®Šå­—ç¬¦
          escape_markdown_v2() {
            echo "$1" | sed -e 's/_/\\_/g' -e 's/\*/\\*/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/~/\\~/g' -e 's/`/\\`/g' -e 's/>/\\>/g' -e 's/#/\\#/g' -e 's/\+/\\+/g' -e 's/-/\\-/g' -e 's/=/\\=/g' -e 's/!/\\!/g' -e 's/{/\\{/g' -e 's/}/\\}/g' -e 's/\./\\./g' -e 's/|/\\|/g'
          }

          if [[ "${{ github.repository_owner }}" == "sxppya" ]]; then
            CAPTION=$(escape_markdown_v2 "âŒ å‘å¸ƒå¤±è´¥! å·²æ‰“åŒ…æ—¥å¿—.
            ğŸ“± è®¾å¤‡: ${{ inputs.device_codename }}
            ğŸ·ï¸ ç‰ˆæœ¬: build-${{ github.run_number }}")

            if [ -f logs.zip ]; then
              curl -F document=@logs.zip \
                -F chat_id=${TG_CHAT_ID} \
                -F caption="$CAPTION" \
                -F parse_mode=MarkdownV2 \
                https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument
            else
              echo "âš ï¸ æœªæ‰¾åˆ° logs.zipï¼Œè·³è¿‡ä¸Šä¼ "
            fi
          else
            echo "â›” éä¸»ä»“åº“ï¼ˆ${{ github.repository_owner }}ï¼‰ï¼Œè·³è¿‡ Telegram æ¨é€"
          fi
